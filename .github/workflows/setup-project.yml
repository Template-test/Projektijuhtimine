name: Initialize GitHub Project with predefined tasks

on:
  workflow_dispatch:
    inputs:
      project_title:
        description: "Name of the new GitHub Project"
        required: true
        default: "Course workboard"

permissions:
  contents: read
  issues: write
  repository-projects: write

jobs:
  setup-project:
    runs-on: ubuntu-latest

    steps:
      - name: Create project and tasks
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PROJECT_PAT || secrets.GITHUB_TOKEN }}
          script: |
            const ownerLogin = context.repo.owner;
            const repoName = context.repo.repo;
            const projectTitle = core.getInput("project_title") || "Course workboard";

            core.info(`Setting up project for repository: ${ownerLogin}/${repoName}`);

            // Create a repository-linked project
            let project = null;

            try {
              core.info('Creating repository-linked project...');
              
              // Use REST API to create a classic project (repository-level)
              // Note: ProjectsV2 (new projects) can only be created at org/user level
              // Classic projects can be linked to repositories
              const projectResponse = await github.rest.projects.createForRepo({
                owner: ownerLogin,
                repo: repoName,
                name: projectTitle,
                body: 'Automated project board for course tasks'
              });
              
              project = projectResponse.data;
              core.info(`âœ… Created repository project: ${project.html_url}`);
              
              // Create default columns for the project
              const columns = ['To Do', 'In Progress', 'Done'];
              const createdColumns = [];
              
              for (const columnName of columns) {
                const column = await github.rest.projects.createColumn({
                  project_id: project.id,
                  name: columnName
                });
                createdColumns.push(column.data);
                core.info(`Created column: ${columnName}`);
              }
              
              project.columns = createdColumns;
              
            } catch (error) {
              core.warning(`Could not create repository project: ${error.message}`);
              core.warning('Continuing with issues only...');
            }

            // Define predefined tasks as issues
            // Edit this array to match your template
            const tasks = [
              {
                title: "Read course instructions",
                body: "Read the README in this repository and the CONTRIBUTING guidelines."
              },
              {
                title: "Set up local development environment",
                body: "Install required tools, clone the repository and run the project locally."
              },
              {
                title: "Complete Task 1",
                body: "Follow Task 1 instructions in the docs folder."
              },
              {
                title: "Complete Task 2",
                body: "Follow Task 2 instructions in the docs folder."
              }
            ];

            // Create issues for each task
            const createdIssues = [];
            let issuesEnabled = true;

            for (const task of tasks) {
              try {
                const issue = await github.rest.issues.create({
                  owner: ownerLogin,
                  repo: repoName,
                  title: task.title,
                  body: task.body,
                  labels: ["task"]
                });
                createdIssues.push(issue.data);
                core.info(`Created issue #${issue.data.number}: ${issue.data.title}`);
              } catch (error) {
                if (error.status === 404) {
                  issuesEnabled = false;
                  core.warning('Issues are not enabled for this repository!');
                  core.warning('Please enable Issues in repository Settings â†’ General â†’ Features');
                  break;
                } else if (error.status === 410) {
                  issuesEnabled = false;
                  core.warning('Issues have been disabled for this repository!');
                  break;
                } else {
                  throw error;
                }
              }
            }

            // If we created a project, add issues to it
            if (project && createdIssues.length > 0) {
              core.info('Adding issues to project...');
              
              // Add issues to the "To Do" column (first column)
              const todoColumn = project.columns[0];
              
              for (const issue of createdIssues) {
                try {
                  await github.rest.projects.createCard({
                    column_id: todoColumn.id,
                    content_id: issue.id,
                    content_type: 'Issue'
                  });
                  core.info(`Added issue #${issue.number} to project`);
                } catch (error) {
                  core.warning(`Could not add issue #${issue.number} to project: ${error.message}`);
                }
              }
              
              core.notice(`âœ… Successfully created ${createdIssues.length} task issues and added them to project!`);
              core.notice(`ğŸ“‹ View project at: ${project.html_url}`);
            } else if (project && !issuesEnabled) {
              core.notice(`âœ… Created repository project: ${project.html_url}`);
              core.notice(`âš ï¸ Issues are not enabled - please enable them in repository settings`);
              core.notice(`   Then manually add tasks to the project, or re-run this workflow`);
            } else if (createdIssues.length > 0) {
              core.notice(`âœ… Successfully created ${createdIssues.length} task issues!`);
              core.notice(`ğŸ“‹ View them at: https://github.com/${ownerLogin}/${repoName}/issues`);
              core.notice(`ğŸ’¡ Project board was not created. Check repository permissions.`);
            } else if (!issuesEnabled) {
              core.setFailed('âš ï¸ Issues are not enabled for this repository!');
              core.notice('Please enable Issues in: Repository Settings â†’ General â†’ Features â†’ Issues');
              if (project) {
                core.notice(`Project was created: ${project.html_url}`);
              }
            }
