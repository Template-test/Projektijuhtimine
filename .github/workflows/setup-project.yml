name: Initialize GitHub Project with predefined tasks

on:
  workflow_dispatch:
    inputs:
      project_title:
        description: "Name of the new GitHub Project"
        required: true
        default: "Course workboard"

permissions:
  contents: read
  issues: write
  repository-projects: write
  id-token: write

jobs:
  setup-project:
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
        continue-on-error: true

      - name: Create project and tasks
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token || secrets.GITHUB_TOKEN }}
          script: |
            const ownerLogin = context.repo.owner;
            const repoName = context.repo.repo;
            const projectTitle = core.getInput("project_title") || "Course workboard";
            const hasAppToken = '${{ steps.generate-token.outputs.token }}' !== '';

            core.info(`Setting up tasks for repository: ${ownerLogin}/${repoName}`);

            // Try to create organization-level project if GitHub App token is available
            let project = null;

            if (hasAppToken) {
              try {
                core.info('GitHub App token found - creating organization project...');
                
                // Get organization ID
                const orgQuery = `
                  query($login: String!) {
                    organization(login: $login) { 
                      id 
                      login
                    }
                  }
                `;
                
                const orgResult = await github.graphql(orgQuery, { login: ownerLogin });
                const ownerId = orgResult.organization.id;
                core.info(`Found organization: ${orgResult.organization.login}`);

                // Create ProjectV2 for organization
                const createProjectMutation = `
                  mutation($ownerId: ID!, $title: String!) {
                    createProjectV2(input: { ownerId: $ownerId, title: $title }) {
                      projectV2 {
                        id
                        url
                        number
                      }
                    }
                  }
                `;

                const createProjectResult = await github.graphql(createProjectMutation, {
                  ownerId,
                  title: projectTitle
                });

                project = createProjectResult.createProjectV2.projectV2;
                core.info(`âœ… Created organization project #${project.number}: ${project.url}`);
                
              } catch (error) {
                core.warning(`Could not create organization project: ${error.message}`);
                core.info('Continuing with issues only...');
              }
            } else {
              core.info('GitHub App not configured - will create issues only');
              core.info('To enable automatic project creation, set up a GitHub App (see workflow output)');
            }

            // Define predefined tasks as issues
            // Edit this array to match your template
            const tasks = [
              {
                title: "Read course instructions",
                body: "Read the README in this repository and the CONTRIBUTING guidelines."
              },
              {
                title: "Set up local development environment",
                body: "Install required tools, clone the repository and run the project locally."
              },
              {
                title: "Complete Task 1",
                body: "Follow Task 1 instructions in the docs folder."
              },
              {
                title: "Complete Task 2",
                body: "Follow Task 2 instructions in the docs folder."
              }
            ];

            // Create issues for each task
            const createdIssues = [];

            for (const task of tasks) {
              try {
                const issue = await github.rest.issues.create({
                  owner: ownerLogin,
                  repo: repoName,
                  title: task.title,
                  body: task.body,
                  labels: ["task"]
                });
                createdIssues.push(issue.data);
                core.info(`âœ… Created issue #${issue.data.number}: ${issue.data.title}`);
              } catch (error) {
                core.error(`Failed to create issue "${task.title}": ${error.message}`);
                throw error;
              }
            }

            core.notice(`ðŸŽ‰ Successfully created ${createdIssues.length} task issues!`);
            core.notice(`ðŸ“‹ View them at: https://github.com/${ownerLogin}/${repoName}/issues`);

            // If project was created, add issues to it
            if (project && createdIssues.length > 0) {
              core.info('Adding issues to project...');
              
              const addItemMutation = `
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                    item {
                      id
                    }
                  }
                }
              `;

              let addedCount = 0;
              for (const issue of createdIssues) {
                try {
                  await github.graphql(addItemMutation, {
                    projectId: project.id,
                    contentId: issue.node_id
                  });
                  addedCount++;
                  core.info(`Added issue #${issue.number} to project`);
                } catch (error) {
                  core.warning(`Could not add issue #${issue.number}: ${error.message}`);
                }
              }
              
              core.notice(``);
              core.notice(`âœ… Added ${addedCount} issues to project!`);
              core.notice(`ðŸ“Š View project board: ${project.url}`);
            } else if (!hasAppToken) {
              core.notice(``);
              core.notice(`ðŸ’¡ To enable automatic project creation:`);
              core.notice(`   1. Create a GitHub App (see: https://docs.github.com/apps/creating-github-apps)`);
              core.notice(`   2. Grant it 'Repository administration' and 'Organization projects' permissions`);
              core.notice(`   3. Install it on your organization`);
              core.notice(`   4. Add APP_ID as a variable and APP_PRIVATE_KEY as a secret`);
              core.notice(`   OR`);
              core.notice(`   Simply create a project manually and add issues with label:task`);
            }
