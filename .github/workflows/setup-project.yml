name: Initialize GitHub Project with predefined tasks

on:
  workflow_dispatch:
    inputs:
      project_title:
        description: "Name of the new GitHub Project"
        required: true
        default: "Course workboard"

permissions:
  contents: read
  issues: write
  repository-projects: write
  id-token: write

jobs:
  setup-project:
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}
        continue-on-error: true

      - name: Create project and tasks
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.generate-token.outputs.token || secrets.GITHUB_TOKEN }}
          script: |
            const ownerLogin = context.repo.owner;
            const repoName = context.repo.repo;
            // Use repository name as the project name
            const projectTitle = repoName;
            const hasAppToken = '${{ steps.generate-token.outputs.token }}' !== '';

            core.info(`Setting up tasks for repository: ${ownerLogin}/${repoName}`);

            // Try to create a repository-level Classic Project first
            // If Classic Projects are disabled (404/410), fall back to org-level ProjectV2 (if App token present)
            let classicProject = null;
            let projectV2 = null;

            try {
              core.info('Attempting to create repository Classic Project...');
              const created = await github.rest.projects.createForRepo({
                owner: ownerLogin,
                repo: repoName,
                name: projectTitle
              });
              classicProject = created.data;
              core.info(`‚úÖ Created repo Classic Project #${classicProject.number}: ${classicProject.html_url}`);

              // Ensure common columns exist
              const desiredColumns = ["To do", "In progress", "Done"];
              const existingCols = await github.rest.projects.listColumns({ project_id: classicProject.id });
              const byName = new Map(existingCols.data.map(c => [c.name, c]));
              for (const col of desiredColumns) {
                if (!byName.has(col)) {
                  const c = await github.rest.projects.createColumn({ project_id: classicProject.id, name: col });
                  byName.set(col, c.data);
                }
              }
            } catch (err) {
              const msg = err?.message || String(err);
              const status = err?.status;
              core.warning(`Repo Classic Project creation failed (${status || 'no-status'}): ${msg}`);
              if (hasAppToken) {
                try {
                  core.info('Falling back to organization Project (Projects v2) using App token...');
                  const orgQuery = `
                    query($login: String!) {
                      organization(login: $login) {
                        id
                        login
                      }
                    }
                  `;
                  const orgResult = await github.graphql(orgQuery, { login: ownerLogin });
                  const ownerId = orgResult.organization.id;

                  const createProjectMutation = `
                    mutation($ownerId: ID!, $title: String!) {
                      createProjectV2(input: { ownerId: $ownerId, title: $title }) {
                        projectV2 { id url number }
                      }
                    }
                  `;
                  const createProjectResult = await github.graphql(createProjectMutation, { ownerId, title: projectTitle });
                  projectV2 = createProjectResult.createProjectV2.projectV2;
                  core.info(`‚úÖ Created organization Project (v2) #${projectV2.number}: ${projectV2.url}`);
                } catch (e2) {
                  core.warning(`Could not create organization Project (v2): ${e2.message}`);
                }
              } else {
                core.info('GitHub App not configured; skipping organization Project creation.');
              }
            }

            // Define predefined tasks as issues
            // Edit this array to match your template
            const tasks = [
              {
                title: "Read course instructions",
                body: "Read the README in this repository and the CONTRIBUTING guidelines."
              },
              {
                title: "Set up local development environment",
                body: "Install required tools, clone the repository and run the project locally."
              },
              {
                title: "Complete Task 1",
                body: "Follow Task 1 instructions in the docs folder."
              },
              {
                title: "Complete Task 2",
                body: "Follow Task 2 instructions in the docs folder."
              }
            ];

            // Create issues for each task
            const createdIssues = [];

            for (const task of tasks) {
              try {
                const issue = await github.rest.issues.create({
                  owner: ownerLogin,
                  repo: repoName,
                  title: task.title,
                  body: task.body,
                  labels: ["task"]
                });
                createdIssues.push(issue.data);
                core.info(`‚úÖ Created issue #${issue.data.number}: ${issue.data.title}`);
              } catch (error) {
                core.error(`Failed to create issue "${task.title}": ${error.message}`);
                throw error;
              }
            }

            core.notice(`üéâ Successfully created ${createdIssues.length} task issues!`);
            core.notice(`üìã View them at: https://github.com/${ownerLogin}/${repoName}/issues`);

            // Add issues to whichever project exists
            if (classicProject && createdIssues.length > 0) {
              core.info('Adding issues to Classic Project...');
              // Prefer "To do" column if present; else first column
              const cols = await github.rest.projects.listColumns({ project_id: classicProject.id });
              const todoCol = cols.data.find(c => c.name.toLowerCase() === 'to do') || cols.data[0];
              let added = 0;
              for (const issue of createdIssues) {
                try {
                  await github.rest.projects.createCard({
                    column_id: todoCol.id,
                    content_id: issue.id,
                    content_type: 'Issue'
                  });
                  added++;
                  core.info(`Added issue #${issue.number} to Classic Project`);
                } catch (e) {
                  core.warning(`Could not add issue #${issue.number} to Classic Project: ${e.message}`);
                }
              }
              core.notice('');
              core.notice(`‚úÖ Added ${added} issues to Classic Project`);
              core.notice(`üìä View project board: ${classicProject.html_url}`);
            } else if (projectV2) {
              // Link org Project (v2) to this repository when possible
              try {
                core.info('Linking Project (v2) to current repository...');
                // Preflight: ensure the App installation has access to this repository
                try {
                  await github.request('GET /repos/{owner}/{repo}', { owner: ownerLogin, repo: repoName });
                } catch (preErr) {
                  throw new Error(`App does not have access to ${ownerLogin}/${repoName}. Install the App on this repository.`);
                }

                // Fetch repository node ID
                const repoNode = await github.graphql(`
                  query($owner: String!, $name: String!) {
                    repository(owner: $owner, name: $name) { id nameWithOwner }
                  }
                `, { owner: ownerLogin, name: repoName });

                // Perform link with Projects v2 feature header
                const linkMutation = `
                  mutation($projectId: ID!, $repositoryId: ID!) {
                    linkProjectV2ToRepository(input: { projectId: $projectId, repositoryId: $repositoryId }) {
                      clientMutationId
                    }
                  }
                `;

                await github.request('POST /graphql', {
                  query: linkMutation,
                  variables: { projectId: projectV2.id, repositoryId: repoNode.repository.id },
                  headers: { 'GraphQL-Features': 'projects_next_graphql' }
                });

                core.info('‚úÖ Linked Project (v2) to repository');
                core.notice('');
                core.notice('üîó Project (v2) linked to this repository.');
                core.notice(`   Repository Projects tab: https://github.com/${ownerLogin}/${repoName}/projects`);
              } catch (linkErr) {
                const msg = linkErr?.message || String(linkErr);
                core.warning(`Could not link Project (v2) to repository: ${msg}`);
                core.notice('');
                core.notice('‚ÑπÔ∏è You can link this project to the repository manually:');
                core.notice('   Open project ‚Üí menu (‚ãØ) ‚Üí Link to a repository ‚Üí select this repo.');
                core.notice('');
                core.notice('If automation should link it, check:');
                core.notice(' - The GitHub App is installed on this repository (selected repos or all repos).');
                core.notice(' - App permissions include Organization projects: write and Repository metadata: read.');
                core.notice(' - Re-run this workflow after installing/updating the App.');
              }

              // Ensure a Board view exists and set it as default if possible
              try {
                const viewsData = await github.graphql(`
                  query($id: ID!) {
                    node(id: $id) {
                      ... on ProjectV2 {
                        id
                        views(first: 20) { nodes { id name layout } }
                      }
                    }
                  }
                `, { id: projectV2.id });

                let boardView = viewsData.node.views.nodes.find(v => v.layout === 'BOARD' || (v.name || '').toLowerCase() === 'board');
                if (!boardView) {
                  const createdView = await github.graphql(`
                    mutation($projectId: ID!) {
                      createProjectV2View(input: { projectId: $projectId, name: "Board", layout: BOARD }) {
                        projectV2View { id name layout }
                      }
                    }
                  `, { projectId: projectV2.id });
                  boardView = createdView.createProjectV2View.projectV2View;
                  core.info('Created Board view for Project (v2)');
                }

                // Try to make Board the default view (may not be supported in all orgs)
                try {
                  await github.graphql(`
                    mutation($projectId: ID!, $viewId: ID!) {
                      updateProjectV2(input: { projectId: $projectId, defaultViewId: $viewId }) {
                        projectV2 { id }
                      }
                    }
                  `, { projectId: projectV2.id, viewId: boardView.id });
                  core.info('‚úÖ Set Board as the default view');
                } catch (setErr) {
                  core.warning(`Could not set Board as default view: ${setErr.message}`);
                  core.notice('');
                  core.notice('‚ÑπÔ∏è If default view cannot be set via API, you can set it manually:');
                  core.notice('   Project ‚Üí Views (‚ãØ) ‚Üí Set as default on the Board view.');
                }
              } catch (viewsErr) {
                core.warning(`Could not ensure Board view: ${viewsErr.message}`);
              }

              // Add created issues to the Project (v2)
              core.info('Adding issues to Project (v2)...');
              const addItemMutation = `
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) { item { id } }
                }
              `;
              let addedCount = 0;
              for (const issue of createdIssues) {
                try {
                  await github.graphql(addItemMutation, { projectId: projectV2.id, contentId: issue.node_id });
                  addedCount++;
                  core.info(`Added issue #${issue.number} to Project (v2)`);
                } catch (error) {
                  core.warning(`Could not add issue #${issue.number} to Project (v2): ${error.message}`);
                }
              }
              core.notice('');
              core.notice(`‚úÖ Added ${addedCount} issues to Project (v2)`);
              core.notice(`üìä View project board: ${projectV2.url}`);
            } else {
              core.notice('');
              core.notice('‚ÑπÔ∏è Skipped adding issues to a project.');
              core.notice('   - To create a repo-attached board, enable Classic Projects');
              core.notice('     Org: Settings ‚Üí Projects (classic) ‚Üí Enable');
              core.notice('     Repo: Settings ‚Üí Features ‚Üí Projects');
              core.notice('   - Or configure the GitHub App to allow org Project (v2) creation.');
            }
